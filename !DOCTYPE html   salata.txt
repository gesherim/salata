!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>–°–∏–º—É–ª—è—Ü–∏—è –±–∏–ª—å—è—Ä–¥–∞</title>
    <link rel="stylesheet" href="/css/simulation.css">
    <script src="/js/game.js" defer></script>
</head>

<body>
   
    <header>
        <div class="nav-container">
            <a href="/" class="logo">
                üé± <span class="logo-text">–ë–∏–ª—å—è—Ä–¥ –°–∏–º—É–ª—è—Ç–æ—Ä</span>
            </a>
            <nav>
                <a th:href="@{/}">üè† –ì–ª–∞–≤–Ω–∞—è</a>
                <a th:href="@{/theory}">üìö –¢–µ–æ—Ä–∏—è</a>
                <a th:href="@{/simulation}" class="active">üéÆ –°–∏–º—É–ª—è—Ü–∏—è</a>
                <a th:href="@{/profile}">üë§ –ü—Ä–æ—Ñ–∏–ª—å</a>
                <a th:href="@{/results}">üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã</a>
               
                <form th:action="@{/logout}" method="post" class="logout-form">
                    <button type="submit" class="logout-btn">
                        üö™ –í—ã—Ö–æ–¥
                    </button>
                </form>
            </nav>
        </div>
    </header>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <main class="wrap">
        <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
        <div id="controls">
            <form id="gameParamsForm">
                <h2>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–≥—Ä—ã</h2>

                <div class="setting">
                    <label>üé± –î–∏–∞–º–µ—Ç—Ä —à–∞—Ä–∞ (–º–º):</label>
                    <input type="number" id="ballDiameter" value="57.15" step="0.01" min="10" max="100" />
                </div>

                <div class="setting">
                    <label>üîß –ú–∞—Ç–µ—Ä–∏–∞–ª —à–∞—Ä–∞:</label>
                    <select id="ballMaterialType">
                        <option value="phenolic" selected>–§–µ–Ω–æ–ª</option>
                        <option value="plastic">–ü–ª–∞—Å—Ç–∏–∫</option>
                        <option value="steel">–°—Ç–∞–ª—å</option>
                        <option value="wood">–î–µ—Ä–µ–≤–æ</option>
                        <option value="glass">–°—Ç–µ–∫–ª–æ</option>
                    </select>
                </div>

                <div class="setting">
                    <label>üü© –¢–∏–ø —Ñ–µ—Ç—Ä–∞ —Å—Ç–æ–ª–∞:</label>
                    <select id="tableMaterial">
                        <option value="tournament" selected>–¢—É—Ä–Ω–∏—Ä–Ω—ã–π</option>
                        <option value="professional">–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π</option>
                        <option value="amateur">–õ—é–±–∏—Ç–µ–ª—å—Å–∫–∏–π</option>
                        <option value="slow">–ú–µ–¥–ª–µ–Ω–Ω—ã–π</option>
                        <option value="fast">–ë—ã—Å—Ç—Ä—ã–π</option>
                    </select>
                </div>

                <button type="button" id="saveParamsBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</button>
            </form>

            <div id="buttons">
                <button id="fullResetBtn">üîÑ –ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å</button>
                <button id="rackBtn">üé± –ü–µ—Ä–µ—Å—Ç–∞–≤–∏—Ç—å –ø–∏—Ä–∞–º–∏–¥—É</button>
                <button id="toggleTraj">üìà –¢—Ä–∞–µ–∫—Ç–æ—Ä–∏—è: –í–∫–ª</button>
                <button id="saveSimulationBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–∏–º—É–ª—è—Ü–∏—é</button>
               
            </div>

            <div class="section">
                <h3>üéØ –®–∞—Ä—ã –≤ –ª—É–∑–∞—Ö</h3>
                <div id="pocketedList" class="pocketed-balls">
                    <span style="color: #666; font-style: italic;">‚Äî</span>
                </div>
            </div>

            <div class="section">
                <h3>üîç –§–∏–ª—å—Ç—Ä –ø–æ —à–∞—Ä–∞–º</h3>
                <label for="ballFilter">–í—ã–±–µ—Ä–∏—Ç–µ —à–∞—Ä –¥–ª—è –æ—Ç—á–µ—Ç–∞:</label>
                <select id="ballFilter">
                    <option value="all" selected>–í—Å–µ —à–∞—Ä—ã</option>
                    <!-- –ù–æ–º–µ—Ä–∞ —à–∞—Ä–æ–≤ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã JS -->
                </select>
            </div>

            <div class="section">
                <h3>üí• –°—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>–®–∞—Ä 1</th>
                                <th>–®–∞—Ä 2</th>
                                <th>V‚ÇÅ –¥–æ</th>
                                <th>V‚ÇÇ –¥–æ</th>
                                <th>V‚ÇÅ –ø–æ—Å–ª–µ</th>
                                <th>V‚ÇÇ –ø–æ—Å–ª–µ</th>
                                <th>–≠–Ω–µ—Ä–≥–∏—è</th>
                                <th>–ò–º–ø—É–ª—å—Å –¥–æ</th>
                                <th>–ò–º–ø—É–ª—å—Å –ø–æ—Å–ª–µ</th>
                                <th>–ö–ü–î</th>



                            </tr>
                        </thead>
                        <tbody id="collisionsBody">
                            <tr>
                                <td colspan="7" style="text-align: center; color: #999; padding: 20px;">
                                    –°—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è –µ—â—ë –Ω–µ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å - —Å—Ç–æ–ª -->
        <div class="table-wrapper table-shadow">
            <div class="canvas-texture">
                <!-- –õ—É–∑—ã -->
                <div class="table-pockets"></div>
                <!-- –†–∞–∑–º–µ—Ç–∫–∞ -->
                <div class="table-markings"></div>
                <!-- –ë–ª–∏–∫ -->
                <div class="table-highlight"></div>
                <!-- Canvas —Å –∏–≥—Ä–æ–π -->
                <canvas id="table" width="960" height="540"></canvas>
            </div>
        </div>
    </main>

    <footer>
        <p>¬© –ë–∏–ª—å—è—Ä–¥ –°–∏–º—É–ª—è—Ç–æ—Ä 2025 | –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π –ø—Ä–æ–µ–∫—Ç</p>
    </footer>

    <!-- CSRF —Ç–æ–∫–µ–Ω –¥–ª—è —Ñ–æ—Ä–º -->
    <script th:inline="javascript">
        /*<![CDATA[*/
        document.addEventListener('DOMContentLoaded', function() {
            const logoutForms = document.querySelectorAll('form[action*="logout"]');
            const csrfToken = /*[[${_csrf?.token}]]*/ null;
            const csrfParam = /*[[${_csrf?.parameterName}]]*/ '_csrf';
            
            if (csrfToken && csrfParam) {
                logoutForms.forEach(form => {
                    const csrfInput = document.createElement('input');
                    csrfInput.type = 'hidden';
                    csrfInput.name = csrfParam;
                    csrfInput.value = csrfToken;
                    form.appendChild(csrfInput);
                });
            }
            
            // JavaScript –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            document.getElementById('testSaveBtn')?.addEventListener('click', async () => {
                console.log('–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...');
                
                const testData = {
                    name: '–¢–µ—Å—Ç–æ–≤–∞—è —Å–∏–º—É–ª—è—Ü–∏—è',
                    ballCount: 16,
                    duration: '120.50',
                    ballsJson: JSON.stringify([
                        { number: 0, inPocket: false, x: 100, y: 100 },
                        { number: 1, inPocket: true, x: 200, y: 200 }
                    ]),
                    collisionsJson: JSON.stringify([
                        { ball1: 0, ball2: 1, speed1Before: '5.0', speed2Before: '0.0' }
                    ]),
                    parametersJson: JSON.stringify({ test: 'data' })
                };
                
                try {
                    const response = await fetch('/simulation/save', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]')?.content || ''
                        },
                        body: JSON.stringify(testData)
                    });
                    
                    const result = await response.json();
                    console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–∞:', result);
                    alert(`–¢–µ—Å—Ç: ${result.success ? '–£—Å–ø–µ—à–Ω–æ' : '–û—à–∏–±–∫–∞'}\n${result.message}`);
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∞:', error);
                    alert('–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∞: ' + error.message);
                }
            });
        });
        /*]]>*/
    </script>
    <script src="billiard-.js"></script>
</body>
</html>












document.addEventListener("DOMContentLoaded", () => {
    const MAX_SPEED = 6; // –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ –º/—Å
    const collisionsBody = document.getElementById("collisionsBody");

    // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    let ballDiameter = parseFloat(document.getElementById("ballDiameter").value);
    let ballMaterial = document.getElementById("ballMaterialType").value;
    let tableMaterial = document.getElementById("tableMaterial").value;

    // –ú–∞—Ç–µ—Ä–∏–∞–ª—ã: –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —É–ø—Ä—É–≥–æ—Å—Ç–∏ (e) –∏ –º–∞—Å—Å—ã (kg)
    const ballMaterials = {
        phenolic: { mass: 0.17, e: 0.9 },
        plastic: { mass: 0.15, e: 0.85 },
        steel: { mass: 0.2, e: 0.95 },
        wood: { mass: 0.12, e: 0.8 },
        glass: { mass: 0.18, e: 0.88 },
    };

    // –°—Ç–æ–ª: –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —Ç—Ä–µ–Ω–∏—è
    const tableFriction = {
        tournament: 0.02,
        professional: 0.03,
        amateur: 0.05,
        slow: 0.08,
        fast: 0.01,
    };

    let balls = []; // –º–∞—Å—Å–∏–≤ —à–∞—Ä–æ–≤ —Å –∏—Ö –ø–æ–∑–∏—Ü–∏—è–º–∏ –∏ —Å–∫–æ—Ä–æ—Å—Ç—è–º–∏
    let collisions = [];

    function initBalls() {
        balls = [];
        for (let i = 0; i < 16; i++) {
            balls.push({
                number: i,
                x: Math.random() * 900 + 30,
                y: Math.random() * 500 + 20,
                vx: Math.random() * MAX_SPEED,
                vy: Math.random() * MAX_SPEED,
                radius: ballDiameter / 2,
                mass: ballMaterials[ballMaterial].mass
            });
        }
    }

    function simulateCollisions() {
        collisions = [];
        for (let i = 0; i < balls.length; i++) {
            for (let j = i + 1; j < balls.length; j++) {
                let b1 = balls[i];
                let b2 = balls[j];

                // –í–µ–∫—Ç–æ—Ä —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è
                let dx = b2.x - b1.x;
                let dy = b2.y - b1.y;
                let dist = Math.sqrt(dx * dx + dy * dy);

                if (dist <= b1.radius + b2.radius) {
                    // –°–∫–æ—Ä–æ—Å—Ç–∏ –¥–æ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è
                    let v1Before = Math.sqrt(b1.vx ** 2 + b1.vy ** 2);
                    let v2Before = Math.sqrt(b2.vx ** 2 + b2.vy ** 2);

                    // –ù–æ—Ä–º–∞–ª—å
                    let nx = dx / dist;
                    let ny = dy / dist;

                    // –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –ø–æ –Ω–æ—Ä–º–∞–ª–∏
                    let dvx = b1.vx - b2.vx;
                    let dvy = b1.vy - b2.vy;
                    let vn = dvx * nx + dvy * ny;

                    if (vn > 0) continue; // —à–∞—Ä —É–∂–µ —Ä–∞—Å—Ö–æ–¥–∏—Ç—Å—è

                    // –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —É–ø—Ä—É–≥–æ—Å—Ç–∏
                    let e = Math.min(ballMaterials[ballMaterial].e, ballMaterials[ballMaterial].e);

                    // –ò–º–ø—É–ª—å—Å
                    let jImpulse = -(1 + e) * vn / (1 / b1.mass + 1 / b2.mass);

                    b1.vx += (jImpulse / b1.mass) * nx;
                    b1.vy += (jImpulse / b1.mass) * ny;
                    b2.vx -= (jImpulse / b2.mass) * nx;
                    b2.vy -= (jImpulse / b2.mass) * ny;

                    // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏
                    let v1After = Math.min(Math.sqrt(b1.vx ** 2 + b1.vy ** 2), MAX_SPEED);
                    let v2After = Math.min(Math.sqrt(b2.vx ** 2 + b2.vy ** 2), MAX_SPEED);
                    b1.vx = b1.vx * v1After / Math.sqrt(b1.vx ** 2 + b1.vy ** 2);
                    b1.vy = b1.vy * v1After / Math.sqrt(b1.vx ** 2 + b1.vy ** 2);
                    b2.vx = b2.vx * v2After / Math.sqrt(b2.vx ** 2 + b2.vy ** 2);
                    b2.vy = b2.vy * v2After / Math.sqrt(b2.vx ** 2 + b2.vy ** 2);

                    // –≠–Ω–µ—Ä–≥–∏—è
                    let energyBefore = 0.5 * b1.mass * v1Before ** 2 + 0.5 * b2.mass * v2Before ** 2;
                    let energyAfter = 0.5 * b1.mass * v1After ** 2 + 0.5 * b2.mass * v2After ** 2;

                    // –ò–º–ø—É–ª—å—Å
                    let momentumBefore = b1.mass * v1Before + b2.mass * v2Before;
                    let momentumAfter = b1.mass * v1After + b2.mass * v2After;

                    // –ö–ü–î
                    let efficiency = (energyAfter / energyBefore) * 100;

                    collisions.push({
                        ball1: b1.number,
                        ball2: b2.number,
                        v1Before: v1Before.toFixed(2),
                        v2Before: v2Before.toFixed(2),
                        v1After: v1After.toFixed(2),
                        v2After: v2After.toFixed(2),
                        energy: energyAfter.toFixed(2),
                        momentumBefore: momentumBefore.toFixed(2),
                        momentumAfter: momentumAfter.toFixed(2),
                        efficiency: efficiency.toFixed(2)
                    });
                }
            }
        }
        updateTable();
    }

    function updateTable() {
        collisionsBody.innerHTML = "";
        if (collisions.length === 0) {
            collisionsBody.innerHTML = `<tr><td colspan="10" style="text-align:center;color:#999;padding:20px;">–°—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è –µ—â—ë –Ω–µ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã</td></tr>`;
        } else {
            collisions.forEach(c => {
                let row = `<tr>
                    <td>${c.ball1}</td>
                    <td>${c.ball2}</td>
                    <td>${c.v1Before}</td>
                    <td>${c.v2Before}</td>
                    <td>${c.v1After}</td>
                    <td>${c.v2After}</td>
                    <td>${c.energy}</td>
                    <td>${c.momentumBefore}</td>
                    <td>${c.momentumAfter}</td>
                    <td>${c.efficiency}</td>
                </tr>`;
                collisionsBody.innerHTML += row;
            });
        }
    }

    document.getElementById("saveParamsBtn").addEventListener("click", () => {
        ballDiameter = parseFloat(document.getElementById("ballDiameter").value);
        ballMaterial = document.getElementById("ballMaterialType").value;
        tableMaterial = document.getElementById("tableMaterial").value;
        initBalls();
        simulateCollisions();
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    initBalls();
    simulateCollisions();
});







