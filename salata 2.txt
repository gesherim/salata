document.addEventListener('DOMContentLoaded', () => {
  const canvas = document.getElementById('table');
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;

 
  const materialDensity = { 
    phenolic: 1400, plastic: 1200, steel: 7850, wood: 700, glass: 2500 
  };
  
  const materialRestitution = { 
    phenolic: 0.92, plastic: 0.75, steel: 0.98, wood: 0.85, glass: 0.90 
  };
  
  const tableFrictionMap = { 
    tournament: 0.985, professional: 0.98, amateur: 0.97, slow: 0.95, fast: 0.99 
  };

  let globalParams = {
    ballDiameter_mm: 57.15,
    material: 'phenolic',
    tableFriction: 0.985,
    mass: 0.17
  };

  function updatePhysicalParameters() {
    const diameter_mm = parseFloat(document.getElementById('ballDiameter')?.value)  57.15;
    const material = document.getElementById('ballMaterialType')?.value  'phenolic';
    const frictionType = document.getElementById('tableMaterial')?.value  'tournament';
    
    const diameter_m = diameter_mm / 1000;
    const radius_m = diameter_m / 2;
    const volume = (4/3) * Math.PI * Math.pow(radius_m, 3);
    const density = materialDensity[material]  1400;
    const mass = volume * density;
    
    globalParams.ballDiameter_mm = diameter_mm;
    globalParams.material = material;
    globalParams.restitution = materialRestitution[material]  0.92;
    globalParams.tableFriction = tableFrictionMap[frictionType]  0.985;
    globalParams.mass = mass;
    globalParams.density = density;
  }

  updatePhysicalParameters();

  let balls = [], cueBall = null, collisions = [], showTrajectory = true;
  let ballRadius = Math.max(12, Math.round(globalParams.ballDiameter_mm / 2));
  const MIN_SPEED = 0.05;
  const PIXELS_PER_METER = 45;
  const MAX_SPEED = 5;
  const DT = 1/60;


  const ballColors = [
    "#ffffff", "#ffff00", "#0000ff", "#ff0000", "#800080", 
    "#ff8c00", "#008000", "#8b0000", "#000000", "#ffff00",
    "#0000ff", "#ff0000", "#800080", "#ff8c00", "#008000", "#8b0000"
  ];

  const rails = { padding: 45 };
  const tableRect = { 
    x: rails.padding, 
    y: rails.padding, 
    w: W - rails.padding*2, 
    h: H - rails.padding*2 
  };
  
  const pockets = [
    {x:tableRect.x, y:tableRect.y},
    {x:tableRect.x + tableRect.w/2, y:tableRect.y},
    {x:tableRect.x + tableRect.w, y:tableRect.y},
    {x:tableRect.x, y:tableRect.y + tableRect.h},
    {x:tableRect.x + tableRect.w/2, y:tableRect.y + tableRect.h},
    {x:tableRect.x + tableRect.w, y:tableRect.y + tableRect.h}
  ]; class Ball {
    constructor(x, y, num){
      this.x = x; this.y = y; this.vx = 0; this.vy = 0;
      this.number = num; this.inPocket = false; 
      this.mass = globalParams.mass;
      this.restitution = globalParams.restitution;
      this.radius = ballRadius;
      this.active = true;
    }
    
    speed() { 
      return Math.hypot(this.vx, this.vy); 
    }
    
    applyFriction() { 
      if (this.inPocket) return;
      this.vx *= globalParams.tableFriction; 
      this.vy *= globalParams.tableFriction;
      if(Math.abs(this.vx) < MIN_SPEED) this.vx = 0; 
      if(Math.abs(this.vy) < MIN_SPEED) this.vy = 0; 
    }
    
    update(dt){
      if(this.inPocket  !this.active) return;
      this.x += this.vx * dt * PIXELS_PER_METER;
      this.y += this.vy * dt * PIXELS_PER_METER;
      this.applyFriction();
      this.checkRails();
    }
    
    checkRails(){
      const left = tableRect.x + this.radius;
      const right = tableRect.x + tableRect.w - this.radius;
      const top = tableRect.y + this.radius;
      const bottom = tableRect.y + tableRect.h - this.radius;
      
      let bounced = false;
      if(this.x < left){ this.x = left; this.vx = Math.abs(this.vx)*0.9; bounced = true; }
      if(this.x > right){ this.x = right; this.vx = -Math.abs(this.vx)*0.9; bounced = true; }
      if(this.y < top){ this.y = top; this.vy = Math.abs(this.vy)*0.9; bounced = true; }
      if(this.y > bottom){ this.y = bottom; this.vy = -Math.abs(this.vy)*0.9; bounced = true; }
      
      if(bounced) {
        recordCollision(null, this, 'rail');
      }
    }
    
    
    draw(){
      if(this.inPocket) return;
      
     
      ctx.beginPath();
      ctx.arc(this.x, this.y, this.radius, 0, Math.PI*2);
      ctx.fillStyle = ballColors[this.number]  '#999';
      ctx.fill();
      ctx.lineWidth = 2;
      ctx.strokeStyle = '#000';
      ctx.stroke();
      
      
      if(this.number !== 0){
        ctx.fillStyle = (this.number === 8 ? '#fff' : '#000');
        ctx.font = ${Math.max(14, this.radius*0.7)}px Arial;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(this.number, this.x, this.y);
      }
    }
  } // --- –§–£–ù–ö–¶–ò–ò –î–õ–Ø –°–¢–û–õ–ö–ù–û–í–ï–ù–ò–ô –ò –¢–ê–ë–õ–ò–¶–´ ---
  function resolveCollision(a,b){
    if(a.inPocket  b.inPocket  !a.active  !b.active) return false;
    
    const dx = b.x - a.x, dy = b.y - a.y;
    const dist = Math.hypot(dx, dy);
    const minDist = a.radius + b.radius;
    
    if(dist >= minDist) return false;
    
    // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º —Å–∫–æ—Ä–æ—Å—Ç–∏ –¥–æ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è
    const speedA_before = a.speed();
    const speedB_before = b.speed();
    
    const nx = dx/dist, ny = dy/dist;
    const overlap = (minDist - dist)/2;
    a.x -= nx*overlap; a.y -= ny*overlap;
    b.x += nx*overlap; b.y += ny*overlap;

    const dvx = b.vx - a.vx, dvy = b.vy - a.vy;
    const velAlongNormal = dvx*nx + dvy*ny;
    if(velAlongNormal > 0) return false;

    const e = Math.min(a.restitution, b.restitution);
    const j = -(1 + e) * velAlongNormal;
    const impulse = j / (1/a.mass + 1/b.mass);
    
    a.vx -= (impulse / a.mass) * nx;
    a.vy -= (impulse / a.mass) * ny;
    b.vx += (impulse / b.mass) * nx;
    b.vy += (impulse / b.mass) * ny;
    
    // –°–∫–æ—Ä–æ—Å—Ç–∏ –ø–æ—Å–ª–µ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è
    const speedA_after = a.speed();
    const speedB_after = b.speed();
    
    // –†–∞—Å—á–µ—Ç –ø–µ—Ä–µ–¥–∞–Ω–Ω–æ–π —ç–Ω–µ—Ä–≥–∏–∏
    const energyBefore = 0.5 * a.mass * Math.pow(speedA_before, 2) +
                        0.5 * b.mass * Math.pow(speedB_before, 2);
    const energyAfter = 0.5 * a.mass * Math.pow(speedA_after, 2) +
                       0.5 * b.mass * Math.pow(speedB_after, 2);
    const energyTransferred = Math.abs(energyAfter - energyBefore);
    
    // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ
    const collision = {
      type: 'ball',
      ball1: a.number,
      ball2: b.number,
      speed1Before: speedA_before.toFixed(3),
      speed2Before: speedB_before.toFixed(3),
      speed1After: speedA_after.toFixed(3),
      speed2After: speedB_after.toFixed(3),
      energyTransferred: energyTransferred.toFixed(5),
      timestamp: Date.now()
    };
    
    collisions.push(collision);
    updateCollisionsTable(collision);
    
    return true;
  }

  function recordCollision(a, b, type) {
    if(type === 'rail' && b) {
      const collision = {
        type: 'rail',
        ball1: null,
        ball2: b.number,
        speed1Before: null,
        speed2Before: b.speed().toFixed(3),
        speed1After: null,
        speed2After: (b.speed() * 0.9).toFixed(3),
        energyTransferred: '0.00000',
        timestamp: Date.now()
      };
      collisions.push(collision);
      updateCollisionsTable(collision);
    }
  }

  // --- –û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ó–ê–ü–û–õ–ù–ï–ù–ò–Ø –¢–ê–ë–õ–ò–¶–´ ---
  function updateCollisionsTable(collision) {
    const tableBody = document.getElementById('collisionsBody');
    if (!tableBody) return;
    
    // –£–±–∏—Ä–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–Ω–µ—Ç —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–π" –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏
    if (tableBody.children.length === 1 && 
        tableBody.children[0].textContent.includes('–°—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è')) {
      tableBody.innerHTML = '';
    }
    
    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É
    const row = document.createElement('tr');
    
    if (collision.type === 'ball') {
      row.innerHTML = `
        <td style="text-align: center;">${collision.ball1}</td>
        <td style="text-align: center;">${collision.ball2}</td>
        <td style="text-align: center;">${collision.speed1Before}</td>
        <td style="text-align: center;">${collision.speed2Before}</td>
        <td style="text-align: center;">${collision.speed1After}</td>
        <td style="text-align: center;">${collision.speed2After}</td>
        <td style="text-align: center;">${collision.energyTransferred}</td>
      `;
    } else if (collision.type === 'rail') {
      row.innerHTML = `
        <td style="text-align: center; color: #666;">‚Äî</td>
        <td style="text-align: center;">${collision.ball2}</td>
        <td style="text-align: center; color: #666;">‚Äî</td>
        <td style="text-align: center;">${collision.speed2Before}</td>
        <td style="text-align: center; color: #666;">‚Äî</td>
        <td style="text-align: center;">${collision.speed2After}</td>
        <td style="text-align: center;">${collision.energyTransferred}</td>
      `;
    } // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –≤ –Ω–∞—á–∞–ª–æ —Ç–∞–±–ª–∏—Ü—ã
    tableBody.insertBefore(row, tableBody.firstChild);
    
    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ –≤ —Ç–∞–±–ª–∏—Ü–µ 
    if (tableBody.children.length > 15) {
      tableBody.removeChild(tableBody.lastChild);
    }
  }

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —à–∞—Ä–æ–≤ –≤ –ª—É–∑–∞—Ö
  function updatePocketedList() {
    const pocketedList = document.getElementById('pocketedList');
    if (!pocketedList) return;
    
    const pocketedBalls = balls.filter(b => b.inPocket && b.number !== 0);
    
    if (pocketedBalls.length === 0) {
      pocketedList.innerHTML = '<span style="color: #666; font-style: italic;">‚Äî</span>';
    } else {
      pocketedList.innerHTML = pocketedBalls
        .sort((a, b) => a.number - b.number)
        .map(b => `<span class="ball-number" style="
          display: inline-block;
          width: 24px;
          height: 24px;
          line-height: 24px;
          border-radius: 50%;
          text-align: center;
          background: ${ballColors[b.number]};
          color: ${b.number === 8 ? '#fff' : '#000'};
          font-weight: bold;
          margin: 2px;
          box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        ">${b.number}</span>`)
        .join('');
    }
  }

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ —à–∞—Ä–∞–º
  function updateBallFilter() {
    const ballFilter = document.getElementById('ballFilter');
    if (!ballFilter) return;
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    const currentValue = ballFilter.value;
    
    // –û—á–∏—â–∞–µ–º –æ–ø—Ü–∏–∏ (–∫—Ä–æ–º–µ "–í—Å–µ —à–∞—Ä—ã")
    while (ballFilter.options.length > 1) {
      ballFilter.remove(1);
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ü–∏–∏ –¥–ª—è –≤—Å–µ—Ö —à–∞—Ä–æ–≤
    balls.filter(b => b.number !== 0 && !b.inPocket)
      .sort((a, b) => a.number - b.number)
      .forEach(ball => {
        const option = document.createElement('option');
        option.value = ball.number;
        option.textContent = –®–∞—Ä ${ball.number};
        ballFilter.appendChild(option);
      });
    
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, –µ—Å–ª–∏ –æ–Ω–æ –µ—â–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    if (currentValue && ballFilter.querySelector(option[value="${currentValue}"])) {
      ballFilter.value = currentValue;
    }
  }

  function checkPocket(ball){
    if(ball.number === 0  ball.inPocket) return;
    
    for(const p of pockets){
      if(Math.hypot(ball.x - p.x, ball.y - p.y) < ball.radius*1.8 && !ball.inPocket){
        ball.inPocket = true;
        ball.vx = 0; ball.vy = 0; ball.active = false;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–∫–∏
        updatePocketedList();
        updateBallFilter();
        break;
      }
    }
  }

  function initBalls(){
  balls = []; 
  collisions = [];
  
  // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–∞–¥–∏—É—Å
  ballRadius = Math.max(12, Math.round(globalParams.ballDiameter_mm / 2));
  
  cueBall = new Ball(tableRect.x + tableRect.w*0.25, tableRect.y + tableRect.h/2, 0);
  balls.push(cueBall);

  // –®–∞—Ä—ã –≤ –ø–∏—Ä–∞–º–∏–¥–µ
  let numbers = [];
  for(let i=1; i<=15; i++) if(i !== üòé numbers.push(i);
  numbers.sort(() => Math.random() - 0.5);
  numbers.splice(7, 0, 8); // –ß–µ—Ä–Ω—ã–π —à–∞—Ä –≤ —Ü–µ–Ω—Ç—Ä–µ –ø–∏—Ä–∞–º–∏–¥—ã (–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ) const startX = tableRect.x + tableRect.w*0.65;
  const startY = tableRect.y + tableRect.h/2;
  const spacing = ballRadius * 2.05; // –ù–µ–º–Ω–æ–≥–æ —É–º–µ–Ω—å—à–∞–µ–º –æ—Ç—Å—Ç—É–ø –¥–ª—è –ª—É—á—à–µ–π –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
  
  let idx = 0;
  let rowOffset = 0;
  
  // –ü–∏—Ä–∞–º–∏–¥–∞ –∏–∑ 5 —Ä—è–¥–æ–≤
  for(let row=0; row<5; row++){
    // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —à–∞—Ä–æ–≤ –≤ —Ç–µ–∫—É—â–µ–º —Ä—è–¥—É
    const ballsInRow = row + 1;
    
    // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º —à–∞—Ä—ã –≤ —Ä—è–¥—É
    for(let col=0; col<ballsInRow; col++){
      if(idx >= numbers.length) break;
      
      // X –ø–æ–∑–∏—Ü–∏—è: –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ —Å–º–µ—â–µ–Ω–∏–µ –º–µ–∂–¥—É —à–∞—Ä–∞–º–∏
      const x = startX + row * (spacing * 0.8660254); // cos(30¬∞) ‚âà 0.8660254
      
      // Y –ø–æ–∑–∏—Ü–∏—è: —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º —Ä—è–¥ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Å–µ—Ä–µ–¥–∏–Ω—ã —Å—Ç–æ–ª–∞
      // –°–Ω–∞—á–∞–ª–∞ –≤—ã—á–∏—Å–ª—è–µ–º –æ–±—â—É—é —à–∏—Ä–∏–Ω—É —Ä—è–¥–∞
      const rowWidth = (ballsInRow - 1) * spacing;
      // –ù–∞—á–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è —Ä—è–¥–∞ (–ª–µ–≤—ã–π –∫—Ä–∞–π)
      const rowStartY = startY - rowWidth/2;
      // –ü–æ–∑–∏—Ü–∏—è –∫–∞–∂–¥–æ–≥–æ —à–∞—Ä–∞
      const y = rowStartY + col * spacing;
      
      balls.push(new Ball(x, y, numbers[idx++]));
    }
  }
  
  // –û–±–Ω–æ–≤–ª—è–µ–º UI
  updatePocketedList();
  updateBallFilter();
  
  // –û—á–∏—â–∞–µ–º —Ç–∞–±–ª–∏—Ü—É —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–π
  const tableBody = document.getElementById('collisionsBody');
  if (tableBody) {
    tableBody.innerHTML = `
      <tr>
        <td colspan="7" style="text-align: center; color: #999; padding: 20px;">
          –°—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è –µ—â—ë –Ω–µ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã
        </td>
      </tr>
    `;
  }
}
  
  initBalls();

 
  let mouse = { x:0, y:0, down:false, start:null };
  
  canvas.addEventListener('mousedown', e => {
    const r = canvas.getBoundingClientRect();
    const clickX = (e.clientX - r.left)*(canvas.width/r.width);
    const clickY = (e.clientY - r.top)*(canvas.height/r.height);
    
    if (cueBall && !cueBall.inPocket) {
      const dist = Math.hypot(clickX - cueBall.x, clickY - cueBall.y);
      if(dist < ballRadius*4){ 
        mouse.down = true; 
        mouse.start = {x: clickX, y: clickY}; 
      }
    }
  });

  window.addEventListener('mouseup', () => {
    if(mouse.down && mouse.start && cueBall && !cueBall.inPocket){
      let dx = (mouse.start.x - cueBall.x)/PIXELS_PER_METER;
      let dy = (mouse.start.y - cueBall.y)/PIXELS_PER_METER;
      
      // –°–∏–ª–∞ —É–¥–∞—Ä–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è
      const distance = Math.hypot(dx, dy);
      const maxPull = 0.4;
      const power = Math.min(distance / maxPull, 1.0);
      
      const HIT_FACTOR = 12 * power;
      cueBall.vx += dx * HIT_FACTOR;
      cueBall.vy += dy * HIT_FACTOR;
      
      let speed = Math.hypot(cueBall.vx, cueBall.vy);
      if(speed > MAX_SPEED){
        cueBall.vx = (cueBall.vx / speed) * MAX_SPEED;
        cueBall.vy = (cueBall.vy / speed) * MAX_SPEED;
      }
    }
    mouse.down = false; 
    mouse.start = null;
  });

  canvas.addEventListener('mousemove', e => {
    const r = canvas.getBoundingClientRect();
    mouse.x = (e.clientX - r.left)*(canvas.width/r.width);
    mouse.y = (e.clientY - r.top)*(canvas.height/r.height);
  });

  function drawTable(){
    ctx.fillStyle='#4b2f1a'; 
    ctx.fillRect(0,0,W,H);
    
    // –ò–≥—Ä–æ–≤–∞—è –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å
    ctx.fillStyle='#0c5c2b';
    ctx.fillRect(tableRect.x, tableRect.y, tableRect.w, tableRect.h);
    
    // –õ—É–∑—ã
    for(const p of pockets){
      ctx.beginPath(); 
      ctx.arc(p.x, p.y, ballRadius*1.8, 0, Math.PI*2);
      ctx.fillStyle='#000'; 
      ctx.fill();
    }
  } // --- –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –°–û–•–†–ê–ù–ï–ù–ò–Ø –°–ò–ú–£–õ–Ø–¶–ò–ò –ù–ê –°–ï–†–í–ï–† ---
 // –í simulation.js –¥–æ–±–∞–≤—å—Ç–µ/–æ–±–Ω–æ–≤–∏—Ç–µ —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é
async function saveSimulationToServer() {
    const simName = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–∏–º—É–ª—è—Ü–∏–∏", "–ú–æ—è –∏–≥—Ä–∞")  "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è";
    if (!simName) return;
    
    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—â—É—é —ç–Ω–µ—Ä–≥–∏—é —Å–∏—Å—Ç–µ–º—ã
    const totalEnergy = balls.reduce((sum, ball) => {
        if (ball.inPocket  !ball.active) return sum;
        return sum + 0.5 * ball.mass * Math.pow(ball.speed(), 2);
    }, 0).toFixed(5);
    
    // –°–æ–±–∏—Ä–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
    const params = {
        ballDiameter: globalParams.ballDiameter_mm,
        ballMaterial: globalParams.material,
        tableFriction: document.getElementById('tableMaterial').value,
        ballMass: globalParams.mass,
        ballDensity: globalParams.density,
        restitution: globalParams.restitution
    };
    
    // –°–æ–±–∏—Ä–∞–µ–º —à–∞—Ä—ã
    const ballsData = balls.map(b => ({
        number: b.number,
        x: b.x, 
        y: b.y,
        vx: b.vx,
        vy: b.vy,
        inPocket: b.inPocket,
        active: b.active,
        mass: b.mass,
        radius: b.radius
    }));
    
    // –°–æ–±–∏—Ä–∞–µ–º —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è
    const collisionsData = collisions.map(c => ({
        type: c.type,
        ball1: c.ball1,
        ball2: c.ball2,
        speed1Before: c.speed1Before,
        speed2Before: c.speed2Before,
        speed1After: c.speed1After,
        speed2After: c.speed2After,
        energyTransferred: c.energyTransferred,
        timestamp: c.timestamp
    }));
    
    // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
    const simData = {
        name: simName,
        params: params,
        collisions: collisionsData,
        balls: ballsData,
        duration: 60, // –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ
        ballCount: balls.filter(b => !b.inPocket).length,
        collisionCount: collisions.length,
        totalEnergyLost: parseFloat(totalEnergy)
    };
    
    console.log("–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä:", simData);

    try {
        const response = await fetch('/simulation/save', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(simData)
        });
        
        console.log("–°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞:", response.status);
        
        if (!response.ok) {
            let errorMessage = HTTP error! status: ${response.status};
            try {
                const errorData = await response.json();
                errorMessage = errorData.message  errorMessage;
            } catch (e) {
                // –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å JSON –æ—à–∏–±–∫–∏
            }
            throw new Error(errorMessage);
        }
        
        const result = await response.json();
        console.log("–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:", result);
        
        if (result.success) {
            alert(‚úÖ –°–∏–º—É–ª—è—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!\nID: ${result.id});
            // –ü–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º
            window.location.href = /simulation/results?id=${result.id};
        } else {
            alert(‚ùå –û—à–∏–±–∫–∞: ${result.message  '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'});
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏:', error);
        alert(‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: ${error.message}\n\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π.);
    }
}
  // --- –û–°–ù–û–í–ù–û–ô –ò–ì–†–û–í–û–ô –¶–ò–ö–õ ---
  function gameLoop() {
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
    updatePhysicalParameters();
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–¥–∏—É—Å
    const newBallRadius = Math.max(12, Math.round(globalParams.ballDiameter_mm / 2));
    if (newBallRadius !== ballRadius) {
      ballRadius = newBallRadius;
      balls.forEach(ball => ball.radius = ballRadius);
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –º–∞—Å—Å—É –∏ —É–ø—Ä—É–≥–æ—Å—Ç—å
    balls.forEach(ball => {
      ball.mass = globalParams.mass;
      ball.restitution = globalParams.restitution;
    });
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è
    for(let i=0; i<balls.length; i++){
      for(let j=i+1; j<balls.length; j++) {
        resolveCollision(balls[i], balls[j]);
      }
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —à–∞—Ä—ã
    for(const b of balls) b.update(DT);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª—É–∑—ã for(const b of balls) if(!b.inPocket) checkPocket(b);
    
    // –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º
    ctx.clearRect(0,0,W,H);
    drawTable();
    for(const b of balls) b.draw();
    
    // –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—é
    if(showTrajectory && mouse.down && mouse.start && cueBall && !cueBall.inPocket){
      ctx.save();
      ctx.strokeStyle='rgba(255,255,255,0.5)'; 
      ctx.setLineDash([6,6]);
      ctx.beginPath(); 
      ctx.moveTo(cueBall.x, cueBall.y); 
      ctx.lineTo(mouse.x, mouse.y); 
      ctx.stroke();
      ctx.setLineDash([]); 
      ctx.restore();
    }
    
    requestAnimationFrame(gameLoop);
  }

  // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø UI ---
  function initUI() {
    // –ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    document.getElementById('saveParamsBtn')?.addEventListener('click', () => {
  updatePhysicalParameters();
});
    
    // –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–∏—Ä–∞–º–∏–¥—ã
    document.getElementById('rackBtn')?.addEventListener('click', () => {
      initBalls();
    });
    
    // –ö–Ω–æ–ø–∫–∞ –ø–æ–ª–Ω–æ–≥–æ —Å–±—Ä–æ—Å–∞
    document.getElementById('fullResetBtn')?.addEventListener('click', () => {
  initBalls();
});
    
    // –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏
    document.getElementById('toggleTraj')?.addEventListener('click', function() {
      showTrajectory = !showTrajectory;
      this.textContent = üìà –¢—Ä–∞–µ–∫—Ç–æ—Ä–∏—è: ${showTrajectory ? '–í–∫–ª' : '–í—ã–∫–ª'};
    });
    
    // –ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–∏–º—É–ª—è—Ü–∏–∏
   // –í initUI() –¥–æ–±–∞–≤—å—Ç–µ:
document.getElementById('saveSimulationBtn')?.addEventListener('click', saveSimulationToServer);
    // –§–∏–ª—å—Ç—Ä –ø–æ —à–∞—Ä–∞–º
    document.getElementById('ballFilter')?.addEventListener('change', function() {
      const selectedBall = this.value;
      
      if (selectedBall === 'all') {
        // –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è
        const allRows = document.querySelectorAll('#collisionsBody tr');
        allRows.forEach(row => row.style.display = '');
      } else {
        // –ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º —à–∞—Ä–æ–º
        const allRows = document.querySelectorAll('#collisionsBody tr');
        allRows.forEach(row => {
          const ball1 = row.cells[0]?.textContent;
          const ball2 = row.cells[1]?.textContent;
          
          if (ball1 === selectedBall || ball2 === selectedBall) {
            row.style.display = '';
          } else {
            row.style.display = 'none';
          }
        });
      }
    });
  }

  // –ó–∞–ø—É—Å–∫
  initUI();
  gameLoop();
});
